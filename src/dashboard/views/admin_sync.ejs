<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .step-indicator .step-item {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-indicator .step-item.completed .step-number {
            background-color: #28a745;
        }

        .step-indicator .step-item.active .step-number {
            background-color: #007bff;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-center">
                            <%= title %>
                        </h2>
                        <p class="text-center text-muted mb-0">
                            <%= message %>
                        </p>
                    </div>
                    <div class="card-body">
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step-item active" id="step-indicator-1">
                                <div class="step-number">1</div>
                                <div>Settings</div>
                            </div>
                            <div class="step-item" id="step-indicator-2">
                                <div class="step-number">2</div>
                                <div>Connect EA</div>
                            </div>
                            <div class="step-item" id="step-indicator-3">
                                <div class="step-number">3</div>
                                <div>Select League</div>
                            </div>
                            <div class="step-item" id="step-indicator-4">
                                <div class="step-number">4</div>
                                <div>Complete</div>
                            </div>
                        </div>

                        <!-- Step 1: League Settings -->
                        <div class="step active" id="step-1">
                            <h4>Step 1: League Settings</h4>
                            <p>First, please set your console and Madden version. This helps us find the correct league.
                            </p>

                            <div class="mb-3">
                                <label for="console-select" class="form-label">Console</label>
                                <select class="form-select" id="console-select" required>
                                    <option value="">Select your console...</option>
                                    <option value="PS5">PlayStation 5</option>
                                    <option value="XBOX">Xbox Series X/S</option>
                                    <option value="PC">PC</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="madden-version" class="form-label">Madden Version</label>
                                <select class="form-select" id="madden-version" required>
                                    <option value="">Select Madden version...</option>
                                    <option value="26" selected>Madden 26</option>
                                    <option value="25">Madden 25</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="user-id" class="form-label">Discord User ID</label>
                                <input type="text" class="form-control" id="user-id"
                                    placeholder="Enter your Discord User ID" required>
                                <div class="form-text">You can get this from Discord by right-clicking your name and
                                    selecting "Copy User ID"</div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="nextStep(1)">Next: Connect to EA
                                Sports</button>
                        </div>

                        <!-- Step 2: EA Sports Connection -->
                        <div class="step" id="step-2">
                            <h4>Step 2: Connect to EA Sports</h4>
                            <p>Connect your EA Sports account to access your Madden leagues.</p>

                            <div class="text-center mb-3">
                                <button type="button" class="btn btn-success btn-lg" onclick="connectEA()">
                                    <i class="fas fa-link"></i> Connect to EA Sports
                                </button>
                            </div>

                            <div id="ea-status" class="alert" style="display: none;"></div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(2)">Previous</button>
                                <button type="button" class="btn btn-primary" id="step-2-next" onclick="nextStep(2)"
                                    disabled>Next: Select League</button>
                            </div>
                        </div>

                        <!-- Step 3: League Selection -->
                        <div class="step" id="step-3">
                            <h4>Step 3: Select Your League</h4>
                            <p>Choose the Madden league you want to connect to LEAGUEbuddy.</p>

                            <div id="leagues-loading" style="display: none;">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading leagues...</span>
                                    </div>
                                    <p>Searching for your leagues...</p>
                                </div>
                            </div>

                            <div id="leagues-list"></div>

                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(3)">Previous</button>
                                <button type="button" class="btn btn-primary" id="step-3-next" onclick="nextStep(3)"
                                    disabled>Complete Setup</button>
                            </div>
                        </div>

                        <!-- Step 4: Complete -->
                        <div class="step" id="step-4">
                            <h4>ðŸŽ‰ Setup Complete!</h4>
                            <div class="alert alert-success">
                                <h5>Your league is now connected to LEAGUEbuddy!</h5>
                                <p>You can now use the following Discord commands:</p>
                                <ul>
                                    <li><code>/ea status</code> - Check connection status</li>
                                    <li><code>/ea sync</code> - Sync league data</li>
                                    <li><code>/ea refresh</code> - Refresh cached data</li>
                                </ul>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-primary btn-lg" onclick="location.reload()">Setup
                                    Another League</button>
                                <a href="/" class="btn btn-secondary btn-lg ms-2">Return to Dashboard</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let selectedLeague = null;
        let eaConnected = false;

        function nextStep(step) {
            if (step === 1) {
                // Validate settings
                const console = document.getElementById('console-select').value;
                const version = document.getElementById('madden-version').value;
                const userId = document.getElementById('user-id').value;

                if (!console || !version || !userId) {
                    alert('Please fill in all required fields');
                    return;
                }
            } else if (step === 2) {
                if (!eaConnected) {
                    alert('Please connect to EA Sports first');
                    return;
                }
                loadLeagues();
            } else if (step === 3) {
                if (!selectedLeague) {
                    alert('Please select a league');
                    return;
                }
                completeSetup();
            }

            // Hide current step
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('completed');

            // Show next step
            currentStep = step + 1;
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('active');
        }

        function prevStep(step) {
            // Hide current step
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');

            // Show previous step
            currentStep = step - 1;
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('active');
            document.getElementById(`step-indicator-${step}`).classList.remove('completed');
        }

        async function connectEA() {
            try {
                const userId = document.getElementById('user-id').value;

                const response = await fetch('/admin/sync/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId })
                });

                const result = await response.json();

                if (result.success) {
                    // Open EA login in new window
                    const popup = window.open(result.loginUrl, 'ea-login', 'width=600,height=700');

                    // Show status
                    const statusDiv = document.getElementById('ea-status');
                    statusDiv.className = 'alert alert-info';
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = '<strong>EA Login Window Opened</strong><br>Please complete authentication in the popup window.';

                    // Check for popup completion
                    const checkClosed = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(checkClosed);
                            // Assume success if popup was closed
                            eaConnected = true;
                            statusDiv.className = 'alert alert-success';
                            statusDiv.innerHTML = '<strong>âœ… EA Sports Connected!</strong><br>You can now proceed to league selection.';
                            document.getElementById('step-2-next').disabled = false;
                        }
                    }, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                const statusDiv = document.getElementById('ea-status');
                statusDiv.className = 'alert alert-danger';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `<strong>Connection Failed</strong><br>${error.message}`;
            }
        }

        async function loadLeagues() {
            try {
                const userId = document.getElementById('user-id').value;
                const console = document.getElementById('console-select').value;
                const maddenVersion = document.getElementById('madden-version').value;

                document.getElementById('leagues-loading').style.display = 'block';

                const response = await fetch('/admin/sync/leagues', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, console, maddenVersion })
                });

                const result = await response.json();

                document.getElementById('leagues-loading').style.display = 'none';

                if (result.success && result.leagues.length > 0) {
                    displayLeagues(result.leagues);
                } else {
                    document.getElementById('leagues-list').innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No Leagues Found</strong><br>
                            No ${maddenVersion} leagues found for ${console}. Make sure you:
                            <ul class="mb-0 mt-2">
                                <li>Have created a league in Madden ${maddenVersion}</li>
                                <li>Selected the correct console</li>
                                <li>Are the commissioner or a member of the league</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('leagues-loading').style.display = 'none';
                document.getElementById('leagues-list').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error Loading Leagues</strong><br>${error.message}
                    </div>
                `;
            }
        }

        function displayLeagues(leagues) {
            const leaguesList = document.getElementById('leagues-list');

            let html = '<div class="row">';
            leagues.forEach((league, index) => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card league-card" onclick="selectLeague('${league.id}', '${league.name}', ${index})">
                            <div class="card-body">
                                <h5 class="card-title">${league.name}</h5>
                                <p class="card-text">
                                    <strong>League ID:</strong> ${league.id}<br>
                                    <strong>Console:</strong> ${league.console || 'Unknown'}<br>
                                    <strong>Teams:</strong> ${league.teams || 'Unknown'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += `
                <style>
                    .league-card {
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .league-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    }
                    .league-card.selected {
                        border-color: #007bff;
                        background-color: #e7f3ff;
                    }
                </style>
            `;

            leaguesList.innerHTML = html;
        }

        function selectLeague(leagueId, leagueName, index) {
            // Remove previous selection
            document.querySelectorAll('.league-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection to clicked card
            document.querySelectorAll('.league-card')[index].classList.add('selected');

            selectedLeague = { id: leagueId, name: leagueName };
            document.getElementById('step-3-next').disabled = false;
        }

        async function completeSetup() {
            try {
                const userId = document.getElementById('user-id').value;
                const console = document.getElementById('console-select').value;
                const maddenVersion = document.getElementById('madden-version').value;

                const response = await fetch('/admin/sync/select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId,
                        leagueId: selectedLeague.id,
                        console,
                        maddenVersion
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Success handled by nextStep()
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert(`Setup failed: ${error.message}`);
            }
        }
    </script>
</body>

</html>